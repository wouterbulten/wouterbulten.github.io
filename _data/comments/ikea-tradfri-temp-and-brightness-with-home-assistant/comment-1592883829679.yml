_id: bf920a90-b503-11ea-8204-632d564d7ba8
replying_to: ''
slug: ikea-tradfri-temp-and-brightness-with-home-assistant
name: mitswan
email: 0f92e09830d5da473fabe84cdf142f41
message: "I know this is old but FWIW I managed to solve this issue by updating the Scene config (via the Deconz API) every 5 mins.  This works because the 'Zigbee Scene' is stored inside the globes.\r\n\r\nThe following adjusts the white balance into sunset with a special late night mode to help preserve your night vision:\r\n\r\n```\r\nfrom requests import post, get, put\r\nfrom datetime import datetime, timedelta\r\nimport json\r\n\r\ndeconzkey = '<use your own>'\r\nhassauth  = {\r\n    \"Authorization\": \"Bearer <use your own>\",\r\n    \"content-type\": \"application/json\",\r\n}\r\nsceneid   = '2'\r\nmins_transition = 60\r\nnoon_xyb = [0.324, 0.329, 254]\r\ndusk_xyb = [0.501, 0.39 , 254]\r\nlate_xyb = [0.461, 0.306, 35 ]\r\n\r\nresponse = get('http://deconz/api/{}/groups/5/scenes/{}'.format(deconzkey,sceneid))\r\nscene    = json.loads(response.text)\r\n\r\nresponse = get('http://homeassistant:8123/api/states',headers=hassauth)\r\nstates   = json.loads(response.text)\r\nsun      = [x for x in states if x['entity_id'] == 'sun.sun'][0]\r\ntzoffset = datetime.now() - datetime.utcnow()\r\nnow      = datetime.now()\r\nsunset   = datetime.fromisoformat(sun['attributes']['next_dusk']) + tzoffset\r\nsunset   = sunset.replace(day=now.day,month=now.month,year=now.year,tzinfo=None)\r\n\r\nblend = min(max((sunset - now).total_seconds() / 60,0),mins_transition) / mins_transition\r\nif now.hour <= 5:\r\n    xyb = late_xyb\r\nelse:\r\n    xyb = [noon_xyb[i]*blend + dusk_xyb[i]*(1-blend) for i in range(3)]\r\n    \r\nfor light in scene['lights']:\r\n    url = 'http://deconz/api/{}/groups/5/scenes/{}/lights/{}/state'.format(deconzkey,sceneid,light['id'])\r\n    response = put(url, data=json.dumps({\"xy\":[xyb[0],xyb[1]],\"bri\":xyb[2]}))\r\n```\r\n\r\nThis could be adapted to accept color and brightness - create a quick scene and immediately switch to it."
id: 1592883829
date: '2020-06-23T03:43:49.673Z'
